version: 2

models:
  - name: monthly_products
    description: "Merc product level inflation report per year-month period"
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - year_month_period
            - product_key
            - category_key
    columns:
      - name: year_month_period
        description: "The year-month period of the report"
        data_type: date
        tests: [ not_null ]

      - name: product_key
        description: "The unique identifier of the product"
        data_type: string
        tests: [ not_null ]

      - name: category_key
        description: "The unique identifier of the category"
        data_type: string
        tests: [ not_null ]

      ####### DATES COLUMNS #######
      - name: processing_date
        description: "The date when the data was processed"
        data_type: date

      - name: earliest_date
        description: "The earliest date available of the product price in the year-month period"
        data_type: date

      - name: latest_date
        description: "The latest date available of the product price in the year-month period"
        data_type: date

      ####### ORIGINAL PRICE COLUMNS #######
      - name: earliest_price
        description: "The earliest price of the product in the year-month period"
        data_type: float
        tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: latest_price
        description: "The latest price of the product in the year-month period"
        data_type: float
        tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: price_variation_abs
        description: "The absolute price variation of the product (earliest_price - latest_price)"
        data_type: float
        tests: [ not_null ]

      - name: price_variation_percent
        description: "The percentage price variation of the product ((earliest_price - latest_price) / earliest_price)"
        data_type: float
        tests: [ not_null ]

      ####### ORIGINAL PRICE COLUMNS #######
      - name: earliest_orig_price
        description: "The earliest original price of the product in the year-month period"
        data_type: float
        tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: latest_orig_price
        description: "The latest original price of the product in the year-month period"
        data_type: float
        tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: orig_price_variation_abs
        description: "The absolute original price variation of the product (earliest_orig_price - latest_orig_price)"
        data_type: float
        tests: [ not_null ]

      - name: orig_price_variation_percent
        description: "The percentage original price variation of the product ((earliest_orig_price - latest_orig_price) / earliest_orig_price)"
        data_type: float
        tests: [ not_null ]


  - name: monthly_product_top_movers
    description: "Merc product level top movers report per year-month period"
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - year_month_period
            - product_key
            - category_key
            - direction
    columns:
      - name: year_month_period
        description: "The year-month period of the report"
        data_type: date
        tests: [ not_null ]

      - name: product_key
        description: "The unique identifier of the product"
        data_type: string
        tests: [ not_null ]

      - name: category_key
        description: "The unique identifier of the category"
        data_type: string
        tests: [ not_null ]

      - name: price_variation_percent
        description: "The percentage price variation of the product ((earliest_price - latest_price) / earliest_price)"
        data_type: float
        tests: [ not_null ]

      - name: direction
        description: "The direction of the price variation (increase or decrease)"
        data_type: string
        tests:
          - not_null
          - accepted_values:
              values: [ 'increase', 'decrease' ]

      - name: rank
        description: "The rank of the product in the top movers list"
        data_type: integer
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: processing_date
        description: "The date when the data was processed"
        data_type: date
        tests: [ not_null ]


  - name: monthly_category_trends
    description: "Merc category level inflation trends report per year-month period"
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - year_month_period
            - category_key
    columns:
      - name: year_month_period
        description: "The year-month period of the report"
        data_type: date
        tests: [ not_null ]

      - name: category_key
        description: "The unique identifier of the category"
        data_type: string
        tests: [ not_null ]

      - name: product_count
        description: "The number of products in the category for the year-month period"
        data_type: integer
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "> 0"

      - name: avg_price_var_pct
        description: "Average price variation percentage across products in the category for the year-month period"
        data_type: float
        tests: [ not_null ]

      - name: stdev_price_var_pct
        description: "Standard deviation of price variation percentage across products in the category for the year-month period"
        data_type: float

      - name: avg_clipped_price_var_pct
        description: "Average clipped price variation percentage across products in the category for the year-month period"
        data_type: float
        tests: [ not_null ]

      - name: avg_orig_price_var_pct
        description: "Average original price variation percentage across products in the category for the year-month period"
        data_type: float
        tests: [ not_null ]

      - name: stdev_orig_price_var_pct
        description: "Standard deviation of original price variation percentage across products in the category for the year-month period"
        data_type: float

      - name: avg_clipped_orig_price_var_pct
        description: "Average clipped original price variation percentage across products in the category for the year-month period"
        data_type: float
        tests: [ not_null ]
