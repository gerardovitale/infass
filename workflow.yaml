main:
  steps:
    - run-selenium-ingestor:
        call: googleapis.run.v1.executions.run
        args:
          name: projects/${sys.get_env("GCP_PROJECT_ID")}/locations/${sys.get_env("GCP_REGION")}/jobs/selenium-ingestor-job

    - create-dataproc-cluster:
        call: googleapis.dataproc.v1.clusters.create
        args:
          projectId: ${sys.get_env("GCP_PROJECT_ID")}
          region: ${sys.get_env("GCP_REGION")}
          cluster:
            clusterName: ephemeral-cluster
            config:
              masterConfig:
                machineTypeUri: n1-standard-2
              workerConfig:
                numInstances: 2
                machineTypeUri: n1-standard-2
        result: cluster_operation

    - check-cluster-status:
        call: googleapis.dataproc.v1.operations.get
        args:
          name: ${cluster_operation.name}
        result: cluster_status

    - check-if-cluster-done:
        switch:
          - condition: ${cluster_status.done == true}
            next: run-pyspark-job
          - condition: ${cluster_status.done == false}
            next: wait-before-cluster-check

    - wait-before-cluster-check:
        call: sys.sleep
        args:
          seconds: 10
        next: check-cluster-status

    - run-pyspark-job:
        call: googleapis.dataproc.v1.jobs.submit
        args:
          projectId: ${sys.get_env("GCP_PROJECT_ID")}
          region: ${sys.get_env("GCP_REGION")}
          job:
            placement:
              clusterName: ephemeral-cluster
            pysparkJob:
              mainPythonFileUri: gs://infass/pyspark-jobs/build_merc_table.py
        result: pyspark_job

    - check-job-status:
        call: googleapis.dataproc.v1.operations.get
        args:
          name: ${pyspark_job.name}
        result: job_status

    - check-if-job-done:
        switch:
          - condition: ${job_status.done == true}
            next: delete-dataproc-cluster
          - condition: ${job_status.done == false}
            next: wait-before-job-check

    - wait-before-job-check:
        call: sys.sleep
        args:
          seconds: 10
        next: check-job-status

    - delete-dataproc-cluster:
        call: googleapis.dataproc.v1.clusters.delete
        args:
          projectId: ${sys.get_env("GCP_PROJECT_ID")}
          region: ${sys.get_env("GCP_REGION")}
          clusterName: ephemeral-cluster
