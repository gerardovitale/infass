name: Reusable â€” Trigger Cloud Run Job

on:
  workflow_call:
    inputs:
      region:
        description: GCP region
        required: true
        type: string
      app_name:
        description: App name (job prefix)
        required: true
        type: string
      component:
        description: Component name (job + container name suffix)
        required: true
        type: string
      args:
        description: Optional arguments for the Cloud Run job
        required: false
        type: string
        default: ""
    secrets:
      gcp_credentials:
        description: JSON service account credentials
        required: true

jobs:
  trigger:
    name: Trigger ${{ inputs.app_name }}-${{ inputs.component }}
    runs-on: ubuntu-latest

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.gcp_credentials }}

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v3.0.1

      - name: Trigger Cloud Run Job
        shell: bash
        run: |
          set -euo pipefail
          gcloud version
          CMD=( gcloud run jobs execute "${{ inputs.app_name }}-${{ inputs.component }}" --region "${{ inputs.region }}" --wait )
          if [ -n "${{ inputs.args }}" ]; then
            CMD+=( --container="${{ inputs.component }}" --args="${{ inputs.args }}" )
          fi
          echo "Executing: ${CMD[*]}"
          "${CMD[@]}"
