name: Reusable — dbt on BigQuery

on:
  workflow_call:
    inputs:
      dbt_directory:
        description: Path to your dbt project
        required: false
        type: string
        default: ./dbt
      dbt_profiles_dir:
        description: Path to profiles dir (relative to repo root)
        required: false
        type: string
        default: ./.dbt
      dbt_profile:
        description: dbt profile name
        required: false
        type: string
        default: infass
      dbt_target:
        description: dbt target name
        required: false
        type: string
        default: test
      python_version:
        description: Python version
        required: false
        type: string
        default: "3.9.19"
      dbt_subcommand:
        description: dbt subcommand to run (build/test/run/etc.)
        required: false
        type: string
        default: build
      dbt_args:
        description: Extra args appended after the subcommand
        required: false
        type: string
        default: ""
      python_warnings:
        description: PYTHONWARNINGS env value
        required: false
        type: string
        default: "ignore::FutureWarning"
    secrets:
      gcp_credentials:
        description: JSON service account credentials for BigQuery
        required: true

jobs:
  dbt:
    name: dbt ${{ inputs.dbt_subcommand }} — ${{ inputs.dbt_profile }}/${{ inputs.dbt_target }}
    runs-on: ubuntu-latest

    env:
      DBT_PROFILES_DIR: ${{ inputs.dbt_profiles_dir }}
      DBT_DIRECTORY: ${{ inputs.dbt_directory }}
      DBT_PROFILE: ${{ inputs.dbt_profile }}
      DBT_TARGET: ${{ inputs.dbt_target }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Set up Python
        uses: actions/setup-python@v5.6.0
        with:
          python-version: ${{ inputs.python_version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles(format('{0}/requirements.txt', inputs.dbt_directory)) }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        working-directory: ${{ env.DBT_DIRECTORY }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2.1.7
        with:
          credentials_json: ${{ secrets.gcp_credentials }}

      - name: Fetch dbt packages
        working-directory: ${{ env.DBT_DIRECTORY }}
        run: dbt deps

      - name: Run dbt ${{ inputs.dbt_subcommand }}
        working-directory: ${{ env.DBT_DIRECTORY }}
        env:
          PYTHONWARNINGS: ${{ inputs.python_warnings }}
        run: |
          dbt ${{ inputs.dbt_subcommand }} \
            --profiles-dir "${{ env.DBT_PROFILES_DIR }}" \
            --profile "${{ env.DBT_PROFILE }}" \
            --target "${{ env.DBT_TARGET }}" \
            ${{ inputs.dbt_args }}
